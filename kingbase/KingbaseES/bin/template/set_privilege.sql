-- Reassign the owner to proper user
-- Audit
UPDATE sys_class 
	SET relowner =
		(
			SELECT oid FROM sys_authid
        	WHERE rolname = '@KINGBASE_SAOUSERNAME@'
		)
    WHERE relname IN ('SYS_AUD',
					'SYS_AUDOBJ',
					'SYS_AUDSET',
					'SYS_AUDRULE',
					-- View from here
					'AUDIT_ACTIONS',
					'SYS_ACTIONS',
					'SYS_AUDIT_MAPS',
					'DBA_AUDIT_OBJECT',
					'DBA_AUDIT_SESSION',
					'DBA_AUDIT_STATEMENT',
					'DBA_AUDIT_TRAIL',
					'DBA_STMT_AUDIT_OPTS',
					'SYS_AUDIT_OBJECT',
					'SYS_AUDIT_OBJECT_TYPE_MAP',
					'SYS_AUDIT_SESSION',
					'SYS_AUDIT_STATEMENT',
					'SYS_AUDIT_TRAIL',
					'SYS_AUDIT_TRAIL_INTERNAL',
					'SYS_OBJ_AUDIT_OPTS',
					'SYS_STMT_AUDIT_OPTS',
					'SYS_PRIV_AUDIT_OPTS',
					'DBA_PRIV_AUDIT_OPTS',
					'DBA_OBJ_AUDIT_OPTS',
					'SYS_AUDTEMPLATE',
					'SYS_LS_AUDITTRAIL'
					);
-- Security
UPDATE sys_class 
	SET relowner = 
		(
			SELECT oid FROM sys_authid
        	WHERE rolname = '@KINGBASE_SSOUSERNAME@'
		)
    WHERE relname IN ('SYS_MAC_COMPARTMENT',
					'SYS_MAC_LABEL',
					'SYS_MAC_LEVEL',
					'SYS_MAC_POLICY',
					'SYS_MAC_POLICY_ENFORCEMENT',
					'SYS_MAC_USER',
					-- View from here
					'SYS_MAC_LEVELS',
					'SYS_MAC_COMPARTMENTS',
					'SYS_MAC_LABELS',
					'SYS_MAC_POLICIES',
					'SYS_MAC_TABLE_POLICIES',
					'SYS_MAC_USER_PRIVS',
					'SYS_MAC_USER_LEVELS',
					'SYS_MAC_USER_COMPARTMENTS',
					'SYS_MAC_LABEL_LEVELS',
					'SYS_MAC_LABEL_COMPARTMENTS',
					'SYS_MAC_SESSION',
					'SYS_MAC_SESSION_LABEL_LOOKUP_INFO',
					'SYS_MAC_SESSION_LABEL_MEDIATION'
					);

-- Audit: FIXME: @KINGBASE_SAOUSERNAME@ should transform 2 times.
UPDATE sys_class
		SET relacl = '{"=r/\"@KINGBASE_SAOUSERNAME@\""}'
		WHERE relkind IN ('v')
		AND relowner = (
			SELECT oid FROM sys_authid
			WHERE rolname = '@KINGBASE_SAOUSERNAME@'
		);

-- Security
UPDATE sys_class
		SET relacl = '{"=r/\"@KINGBASE_SSOUSERNAME@\""}'
		WHERE relkind IN ('v')
		AND relowner = (
			SELECT oid FROM sys_authid
        	WHERE rolname = '@KINGBASE_SSOUSERNAME@'
		);

-- set privilege to superuser and public
UPDATE sys_class 
		SET relacl = '{"=r/\"@KINGBASE_SUPERUSERNAME@\""}'
		WHERE relkind IN ('r', 'm', 'v', 'S')
		AND relacl IS NULL
		--bug#21499: non administrator dosn't has privilege on SYS_EVENT
		AND relname != 'SYS_EVENT'
		AND relowner = (
			SELECT oid FROM sys_authid
        	WHERE rolname = '@KINGBASE_SUPERUSERNAME@'
		);

-- set owner to sao for sao related function
ALTER FUNCTION create_audit_rule OWNER TO "@KINGBASE_SAOUSERNAME@";
ALTER FUNCTION alter_audit_rule OWNER TO "@KINGBASE_SAOUSERNAME@";
ALTER FUNCTION drop_audit_rule OWNER TO "@KINGBASE_SAOUSERNAME@";
ALTER FUNCTION apply_audit_rule OWNER TO "@KINGBASE_SAOUSERNAME@";

-- set owner to sso for sso related function
ALTER FUNCTION create_level OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION create_compartment OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION create_label OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION create_policy OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION drop_level(text,text) OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION drop_level(text,int4) OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION drop_compartment(text,text) OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION drop_compartment(text,int4) OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION drop_label(text,text) OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION drop_label(text,int4) OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION drop_policy OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION disable_policy OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION enable_policy OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION alter_label(text,text,text) OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION alter_label(text,int4,text) OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION set_user_labels OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION drop_user_access OWNER TO "@KINGBASE_SSOUSERNAME@";
/* ALTER FUNCTION set_default_label OWNER TO "@KINGBASE_SSOUSERNAME@"; */
ALTER FUNCTION apply_table_policy OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION remove_table_policy OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION set_user_privs OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION read_mediation OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION write_mediation OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION label_insert OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION label_update OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION set_levels OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION set_compartments OWNER TO "@KINGBASE_SSOUSERNAME@";
/* ALTER FUNCTION set_def_row_label OWNER TO "@KINGBASE_SSOUSERNAME@";  */
/* ALTER FUNCTION set_row_label OWNER TO "@KINGBASE_SSOUSERNAME@";       */
ALTER FUNCTION generate_default_label_value OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION policy_read_max_label_id OWNER TO "@KINGBASE_SSOUSERNAME@";
ALTER FUNCTION policy_read_min_label_id OWNER TO "@KINGBASE_SSOUSERNAME@";

-- Grant the select to PUBLIC
GRANT USAGE ON SCHEMA sys_catalog TO PUBLIC;
GRANT CREATE, USAGE ON SCHEMA public TO PUBLIC;
		
/* BUGID: 7395: grant tablespace system's privilege TO public */
GRANT CREATE ON TABLESPACE SYSTEM TO PUBLIC;

-- revoke all privileges on audit table from public
REVOKE ALL ON SYS_AUD, SYS_AUDOBJ, SYS_AUDSET, SYS_AUDRULE FROM public;
-- revoke all privileges on audit view from public
REVOKE ALL ON AUDIT_ACTIONS,
				SYS_ACTIONS,
				SYS_AUDIT_MAPS,
				DBA_AUDIT_OBJECT,
				DBA_AUDIT_SESSION,
				DBA_AUDIT_STATEMENT,
				DBA_AUDIT_TRAIL,
				DBA_STMT_AUDIT_OPTS,
				SYS_AUDIT_OBJECT,
				SYS_AUDIT_OBJECT_TYPE_MAP,
				SYS_AUDIT_SESSION,
				SYS_AUDIT_STATEMENT,
				SYS_AUDIT_TRAIL,
				SYS_AUDIT_TRAIL_INTERNAL,
				SYS_OBJ_AUDIT_OPTS,
				SYS_STMT_AUDIT_OPTS,
				SYS_PRIV_AUDIT_OPTS,
				DBA_PRIV_AUDIT_OPTS,
				DBA_OBJ_AUDIT_OPTS,
				SYS_AUDTEMPLATE,
				SYS_LS_AUDITTRAIL
				FROM public;
				
-- revoke all privileges on security table from public
REVOKE ALL ON SYS_MAC_COMPARTMENT, SYS_MAC_LABEL, SYS_MAC_LEVEL, SYS_MAC_POLICY,
			  SYS_MAC_USER, SYS_MAC_POLICY_ENFORCEMENT FROM public;

-- drop not null constraint on some columns
ALTER TABLE SYS_AUD 
ALTER COLUMN AUDLOGOFFTIME DROP NOT NULL,
ALTER COLUMN AUDRELNAMESPACE 	DROP NOT NULL,
ALTER COLUMN AUDOBJNAME     	 DROP NOT NULL,
ALTER COLUMN AUDOBJID        	DROP NOT NULL,
ALTER COLUMN AUDOBJTYPE        DROP NOT NULL,
ALTER COLUMN AUDNEWOBJECTNAME  DROP NOT NULL,
ALTER COLUMN AUDOWNER          DROP NOT NULL,
ALTER COLUMN AUDNEWOWNER       DROP NOT NULL,
ALTER COLUMN AUDISGRANT        DROP NOT NULL,
ALTER COLUMN AUDGRANTOPT       DROP NOT NULL,
ALTER COLUMN AUDADMINOPT       DROP NOT NULL;

--for dbms_job
GRANT EXECUTE ON PACKAGE DBMS_JOB TO PUBLIC;
GRANT EXECUTE ON PACKAGE DBMS_METADATA TO PUBLIC;